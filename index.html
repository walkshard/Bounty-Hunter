<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bounty Hunter: Level 1</title>
    <style>
        /* Modernized Retro Palette */
        :root {
            --bg-color: #111;
            --control-bg: #2b2b2b;
            --btn-bg: #444;
            --btn-border: #666;
            --text-color: #fff;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            touch-action: none; 
            font-family: monospace;
        }

        #game-container {
            width: 100%;
            max-width: 600px;
            background-color: #FF7F50; /* Sunset Sky Fallback */
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            border-bottom: 4px solid #000;
            position: relative;
        }

        canvas {
            image-rendering: pixelated;
            width: 100%;
            height: 100%;
            max-height: 60vh;
            object-fit: contain;
        }

        #controls {
            width: 100%;
            max-width: 600px;
            height: 40vh;
            background-color: var(--control-bg);
            display: flex;
            flex-direction: column;
            padding: 10px;
            box-sizing: border-box;
        }

        .control-row {
            display: flex;
            justify-content: space-between;
            flex: 1;
            margin-bottom: 10px;
        }

        .d-pad, .action-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            background-color: var(--btn-bg);
            color: var(--text-color);
            border: 4px solid var(--btn-border);
            border-radius: 8px;
            font-size: 24px;
            font-weight: bold;
            width: 70px;
            height: 70px;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
        }
        
        .btn:active { background-color: #222; border-color: #444; }

        .action-buttons .btn {
            border-radius: 50%;
            width: 80px;
            height: 80px;
            background-color: #8B0000; /* Red action buttons */
            border-color: #B22222;
        }
        .action-buttons .btn:active { background-color: #600000; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas" width="320" height="288"></canvas>
</div>

<div id="controls">
    <div class="control-row">
        <div class="d-pad">
            <div class="btn" id="btn-left">◀</div>
            <div class="btn" id="btn-right">▶</div>
        </div>
        <div class="action-buttons">
            <div class="btn" id="btn-shoot">B</div>
            <div class="btn" id="btn-jump">A</div>
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // --- EXPANDED COLOR PALETTE ---
    const COLOR = {
        skyTop: '#FF4500',     // Deep Orange
        skyBot: '#FFD700',     // Golden Yellow
        sun: '#FFF5EE',        // White sun
        mountains: '#4B0082',  // Purple mountains
        plateaus: '#D2691E',   // Chocolate/Orange rocks
        sand: '#F4A460',       // Sandy brown
        sandDark: '#8B4513',   // Dark sand edge
        cactus: '#228B22',     // Forest Green
        playerHat: '#8B4513',  // Brown
        playerPoncho: '#4682B4',// Steel Blue
        playerSkin: '#FFC0CB', // Pinkish
        laser: '#00FFFF',      // Cyan Laser (Cowboy)
        enemyLaser: '#FF0000', // Red Laser (Enemies)
        enemy: '#8B0000',      // Dark Red Scorpions
        bossMain: '#708090',   // Slate Gray
        bossDark: '#2F4F4F'    // Dark Slate
    };

    let cameraX = 0;
    let gameState = "PLAYING"; 
    const keys = { left: false, right: false, jump: false, shoot: false };

    // --- PLAYER STATS ---
    const player = {
        x: 50, y: 100, width: 16, height: 24,
        vx: 0, vy: 0, 
        speed: 3.0,       
        jumpPower: -6.5,  
        grounded: false, facingRight: true,
        hp: 5, maxHp: 5, invulnTimer: 0
    };

    let lasers = [];
    let enemyLasers = [];
    let enemies = [];
    let boss = null;

    // --- EXTENDED LEVEL MAP ---
    const levelMap = [
        "                                                                                                                                              ",
        "                                                                                                                                              ",
        "                                                                                                                                              ",
        "                                     11111                     111111                                                                     ",
        "                                                                                                     111111                               ",
        "                        1111                      1111                   111                                       11111                  ",
        "                                                                                   1111                                                   ",
        "11111111111111   11111111111111   1111111111111111111   1111111111111111   11111111111111   11111111111111   11111111111111111111111111111",
        "11111111111111   11111111111111   1111111111111111111   1111111111111111   11111111111111   11111111111111   11111111111111111111111111111"
    ];
    
    const tileSize = 32;
    const groundY = 7 * tileSize; 
    const levelWidth = levelMap[0].length * tileSize;
    const bossTriggerX = levelWidth - 400;

    let platforms = [];
    for (let row = 0; row < levelMap.length; row++) {
        for (let col = 0; col < levelMap[row].length; col++) {
            if (levelMap[row][col] === '1') {
                platforms.push({ x: col * tileSize, y: row * tileSize, width: tileSize, height: tileSize });
            }
        }
    }

    // --- EXPANDED ENEMY HORDE ---
    enemies.push({ x: 650, y: 212, width: 16, height: 12, vx: -1, startX: 650, patrol: 40, hp: 2 });
    enemies.push({ x: 800, y: 212, width: 16, height: 12, vx: -1, startX: 800, patrol: 40, hp: 2 });
    enemies.push({ x: 1200, y: 212, width: 16, height: 12, vx: -1, startX: 1200, patrol: 40, hp: 2 });
    enemies.push({ x: 1400, y: 212, width: 16, height: 12, vx: -1, startX: 1400, patrol: 40, hp: 2 });
    enemies.push({ x: 1900, y: 212, width: 16, height: 12, vx: -1, startX: 1900, patrol: 40, hp: 2 });
    enemies.push({ x: 2100, y: 212, width: 16, height: 12, vx: -1, startX: 2100, patrol: 40, hp: 2 });
    enemies.push({ x: 2500, y: 212, width: 16, height: 12, vx: -1, startX: 2500, patrol: 40, hp: 2 });

    // --- CONTROLS LOGIC ---
    function setupControls() {
        const bindBtn = (id, key) => {
            const btn = document.getElementById(id);
            btn.addEventListener('touchstart', (e) => { e.preventDefault(); keys[key] = true; });
            btn.addEventListener('touchend', (e) => { e.preventDefault(); keys[key] = false; });
            btn.addEventListener('mousedown', (e) => { e.preventDefault(); keys[key] = true; });
            btn.addEventListener('mouseup', (e) => { e.preventDefault(); keys[key] = false; });
        };
        bindBtn('btn-left', 'left');
        bindBtn('btn-right', 'right');
        bindBtn('btn-jump', 'jump');
        
        const shootBtn = document.getElementById('btn-shoot');
        const fire = (e) => {
            e.preventDefault();
            if (gameState === "PLAYING" || gameState === "BOSS") {
                lasers.push({
                    x: player.facingRight ? player.x + 18 : player.x - 8,
                    y: player.y + 14, 
                    width: 8, height: 3,
                    vx: player.facingRight ? 8 : -8
                });
            } else if (gameState === "GAMEOVER" || gameState === "WIN") {
                location.reload(); 
            }
        };
        shootBtn.addEventListener('touchstart', fire);
        shootBtn.addEventListener('mousedown', fire);
    }

    function checkAABB(r1, r2) {
        return r1.x < r2.x + r2.width &&
               r1.x + r1.width > r2.x &&
               r1.y < r2.y + r2.height &&
               r1.y + r1.height > r2.y;
    }

    function updatePlayer() {
        if (player.invulnTimer > 0) player.invulnTimer--;

        if (keys.left) { player.vx = -player.speed; player.facingRight = false; }
        else if (keys.right) { player.vx = player.speed; player.facingRight = true; }
        else { player.vx = 0; }

        player.x += player.vx;

        for (let p of platforms) {
            if (checkAABB(player, p)) {
                if (player.vx > 0) player.x = p.x - player.width;
                else if (player.vx < 0) player.x = p.x + p.width;
            }
        }

        if (player.x < cameraX) player.x = cameraX;

        player.vy += 0.3; 
        if (keys.jump && player.grounded) {
            player.vy = player.jumpPower;
            player.grounded = false;
        }
        
        player.y += player.vy;
        player.grounded = false;

        for (let p of platforms) {
            if (checkAABB(player, p)) {
                if (player.vy > 0) { 
                    player.y = p.y - player.height;
                    player.vy = 0;
                    player.grounded = true;
                } else if (player.vy < 0) { 
                    player.y = p.y + p.height;
                    player.vy = 0;
                }
            }
        }

        if (player.y > canvas.height) takeDamage(5);

        if (gameState === "PLAYING") {
            if (player.x > cameraX + canvas.width / 2) {
                cameraX = player.x - canvas.width / 2;
            }
            if (player.x > bossTriggerX) {
                gameState = "BOSS";
                spawnBoss();
            }
        }
    }

    function takeDamage(amt) {
        if (player.invulnTimer > 0) return;
        player.hp -= amt;
        player.invulnTimer = 30; 
        if (player.hp <= 0) gameState = "GAMEOVER";
    }

    function spawnBoss() {
        boss = {
            x: cameraX + 240, y: groundY - 60, width: 48, height: 60,
            hp: 30, maxHp: 30,
            state: "IDLE", timer: 0
        };
    }

    function updateBoss() {
        if (!boss) return;
        boss.timer++;
        
        if (boss.state === "IDLE") {
            if (boss.timer > 40) {
                boss.state = "ATTACK";
                boss.timer = 0;
            }
        } else if (boss.state === "ATTACK") {
            // FIXED TARGETING: Laser shoots from lower gun arm, directly at player height
            if (boss.timer === 10 || boss.timer === 25 || boss.timer === 40) {
                enemyLasers.push({ x: boss.x - 8, y: boss.y + 36, width: 12, height: 6, vx: -5 });
            }
            if (boss.timer > 70) {
                boss.state = "JUMP";
                boss.timer = 0;
                boss.vy = -6;
            }
        } else if (boss.state === "JUMP") {
            boss.vy += 0.3;
            boss.y += boss.vy;
            
            // Move slightly forward while jumping
            boss.x -= 1; 
            
            if (boss.y > groundY - boss.height) {
                boss.y = groundY - boss.height;
                boss.vy = 0;
                boss.x += 30; // Snap back
                boss.state = "IDLE";
                boss.timer = 0;
            }
        }

        if (checkAABB(player, boss)) takeDamage(1);
    }

    function update() {
        if (gameState === "PLAYING" || gameState === "BOSS") {
            updatePlayer();

            for (let i = lasers.length - 1; i >= 0; i--) {
                lasers[i].x += lasers[i].vx;
                let hit = false;
                
                for (let j = enemies.length - 1; j >= 0; j--) {
                    if (checkAABB(lasers[i], enemies[j])) {
                        enemies[j].hp--;
                        hit = true;
                        if (enemies[j].hp <= 0) enemies.splice(j, 1);
                        break;
                    }
                }

                if (boss && checkAABB(lasers[i], boss)) {
                    boss.hp--;
                    hit = true;
                    if (boss.hp <= 0) {
                        boss = null;
                        gameState = "WIN";
                    }
                }

                if (hit || lasers[i].x > cameraX + canvas.width || lasers[i].x < cameraX) {
                    lasers.splice(i, 1);
                }
            }

            for (let e of enemies) {
                e.x += e.vx;
                if (e.x > e.startX + e.patrol || e.x < e.startX - e.patrol) e.vx *= -1;
                if (checkAABB(player, e)) takeDamage(1);
            }

            for (let i = enemyLasers.length - 1; i >= 0; i--) {
                enemyLasers[i].x += enemyLasers[i].vx;
                if (checkAABB(player, enemyLasers[i])) {
                    takeDamage(1);
                    enemyLasers.splice(i, 1);
                }
            }

            if (gameState === "BOSS") updateBoss();
        }
    }

    // --- DRAWING FUNCTIONS ---
    function drawBackground() {
        ctx.save();
        
        // Gradient Sky
        let gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
        gradient.addColorStop(0, COLOR.skyTop);
        gradient.addColorStop(1, COLOR.skyBot);
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Sun
        ctx.fillStyle = COLOR.sun;
        ctx.beginPath();
        ctx.arc(200, 100, 30, 0, Math.PI * 2);
        ctx.fill();

        // Parallax Plateaus
        ctx.fillStyle = COLOR.plateaus;
        let pOffsetX = (cameraX * 0.1) % 400;
        for(let i = -1; i < 6; i++) {
            let px = i * 200 - pOffsetX;
            let py = groundY - 60;
            ctx.fillRect(px, py, 140, 60); 
        }

        // Parallax Mountains
        ctx.fillStyle = COLOR.mountains;
        let mOffsetX = (cameraX * 0.25) % 320;
        for(let i = -1; i < 6; i++) {
            ctx.beginPath();
            ctx.moveTo(i * 120 - mOffsetX, groundY);
            ctx.lineTo(i * 120 + 60 - mOffsetX, groundY - 100);
            ctx.lineTo(i * 120 + 120 - mOffsetX, groundY);
            ctx.fill();
        }

        // Parallax Cactuses
        ctx.fillStyle = COLOR.cactus;
        let cOffsetX = (cameraX * 0.5) % 320;
        for(let i = -1; i < 6; i++) {
            let cx = i * 150 - cOffsetX + 60;
            let cy = groundY - 30;
            ctx.fillRect(cx, cy, 8, 30); 
            ctx.fillRect(cx - 6, cy + 8, 6, 4); 
            ctx.fillRect(cx - 6, cy + 4, 4, 8);
            ctx.fillRect(cx + 8, cy + 14, 6, 4); 
            ctx.fillRect(cx + 10, cy + 10, 4, 8);
        }
        ctx.restore();
    }

    function draw() {
        drawBackground();

        ctx.save();
        ctx.translate(-cameraX, 0);

        // Draw Platforms (Sand blocks)
        for (let p of platforms) {
            if (p.x + p.width > cameraX && p.x < cameraX + canvas.width) {
                ctx.fillStyle = COLOR.sandDark;
                ctx.fillRect(p.x, p.y, p.width, p.height);
                ctx.fillStyle = COLOR.sand;
                ctx.fillRect(p.x, p.y, p.width, p.height - 4); 
            }
        }

        // Draw Scorpions (Red)
        for (let e of enemies) {
            let ex = e.x, ey = e.y;
            ctx.fillStyle = COLOR.enemy;
            ctx.fillRect(ex + 4, ey + 4, 12, 8); 
            ctx.fillRect(ex, ey + 8, 4, 4); 
            ctx.fillRect(ex + 12, ey - 4, 4, 8);
            ctx.fillRect(ex + 16, ey - 4, 4, 4); 
            ctx.fillStyle = "#FFF"; // Evil eye
            ctx.fillRect(ex + 4, ey + 6, 2, 2);
        }

        // --- NEW BOSS: WAR MECH ---
        if (boss) {
            let bx = boss.x, by = boss.y;
            // Treads
            ctx.fillStyle = "#333";
            ctx.fillRect(bx - 4, by + boss.height - 12, boss.width + 8, 12);
            
            // Main Chassis
            ctx.fillStyle = COLOR.bossMain;
            ctx.fillRect(bx, by + 12, boss.width, boss.height - 24);
            
            // Head/Cockpit
            ctx.fillStyle = COLOR.bossDark;
            ctx.fillRect(bx + 8, by, boss.width - 16, 12);
            
            // Glowing Red Eye
            ctx.fillStyle = "#FF0000";
            ctx.fillRect(bx + 12, by + 4, 8, 4); 
            
            // Big Arm Cannon (Shoots at player chest height)
            ctx.fillStyle = "#555";
            ctx.fillRect(bx - 16, by + 32, 24, 12);
            ctx.fillStyle = "#222";
            ctx.fillRect(bx - 16, by + 34, 4, 8); // Barrel tip
        }

        // Draw Player (Space Cowboy - Colored)
        if (player.invulnTimer % 4 < 2) {
            let px = player.x;
            let py = player.y;

            // Hat
            ctx.fillStyle = COLOR.playerHat;
            ctx.fillRect(px + 2, py, 12, 4); 
            ctx.fillRect(px - 4, py + 4, 24, 2); 
            
            // Face
            ctx.fillStyle = COLOR.playerSkin; 
            ctx.fillRect(px + 2, py + 6, 12, 6); 
            
            // Eyes
            ctx.fillStyle = "#000"; 
            if (player.facingRight) ctx.fillRect(px + 10, py + 8, 2, 2); 
            else ctx.fillRect(px + 4, py + 8, 2, 2); 
            
            // Poncho
            ctx.fillStyle = COLOR.playerPoncho;
            ctx.fillRect(px, py + 12, 16, 8); 
            
            // Boots
            ctx.fillStyle = "#777";
            ctx.fillRect(px + 2, py + 20, 4, 4); 
            ctx.fillRect(px + 10, py + 20, 4, 4);
            
            // Blaster
            ctx.fillStyle = "#333";
            if (player.facingRight) ctx.fillRect(px + 12, py + 14, 8, 3); 
            else ctx.fillRect(px - 4, py + 14, 8, 3); 
        }

        // Draw Lasers
        ctx.fillStyle = COLOR.laser;
        for (let l of lasers) ctx.fillRect(l.x, l.y, l.width, l.height);
        
        ctx.fillStyle = COLOR.enemyLaser;
        for (let l of enemyLasers) ctx.fillRect(l.x, l.y, l.width, l.height);

        ctx.restore();

        // UI
        ctx.fillStyle = "#FFF";
        ctx.font = "bold 16px monospace";
        ctx.fillText("HP: ", 10, 25);
        ctx.fillStyle = "#FF0000";
        ctx.fillText("♥".repeat(player.hp), 40, 25);

        if (gameState === "BOSS") {
            ctx.fillStyle = "#FFF";
            ctx.fillText("WARLORD: ", canvas.width / 2 - 80, 25);
            ctx.fillStyle = "#FF0000";
            ctx.fillText("█".repeat(Math.ceil(boss.hp/2)), canvas.width / 2, 25);
        } else if (gameState === "GAMEOVER") {
            ctx.fillStyle = "rgba(0,0,0,0.8)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#FFF";
            ctx.font = "bold 24px monospace";
            ctx.fillText("YOU DIED", canvas.width/2 - 50, canvas.height/2);
            ctx.font = "16px monospace";
            ctx.fillText("Tap B to retry", canvas.width/2 - 65, canvas.height/2 + 30);
        } else if (gameState === "WIN") {
            ctx.fillStyle = "rgba(0,0,0,0.8)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#00FF00";
            ctx.font = "bold 24px monospace";
            ctx.fillText("WARLORD DEFEATED"
